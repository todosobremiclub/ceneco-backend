<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pagos - Ceneco</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: url('/fondo.png') no-repeat center center fixed;
      background-size: cover;
      color: #1a1a1a;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background-color: #0b3d91;
      padding-top: 60px;
      box-sizing: border-box;
      z-index: 1000;
    }

    .sidebar a, .sidebar button {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      color: #ffffff;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      border: none;
      background: none;
      cursor: pointer;
    }

    .sidebar a:hover, .sidebar button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      padding-left: 30px;
    }

    header {
      position: fixed;
      top: 0;
      left: 220px;
      right: 0;
      height: 60px;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 500;
      font-weight: 600;
      font-size: 17px;
      color: #153E75;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-header {
      height: 30px;
      width: auto;
    }

    main {
      margin-left: 220px;
      padding: 80px 15px 20px 15px;
    }

    h1 {
      font-size: 20px;
      color: #153E75;
      font-weight: 600;
      margin: 0;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 12px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background-color: #f5f7fa;
      font-weight: 600;
      color: #0D1B2A;
    }

    tbody tr:hover {
      background-color: #f0f4f8;
    }

    .nuevo-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .form-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 0 auto;
      display: none;
    }

    .form-container h2 {
      margin-bottom: 20px;
      color: #153E75;
      font-size: 18px;
    }

    .form-container label {
      display: block;
      font-weight: 500;
      margin-bottom: 5px;
      color: #153E75;
      font-size: 14px;
    }

    .form-container input, .form-container select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-container button {
      padding: 10px 16px;
      background-color: #2196F3;
      border: none;
      color: white;
      border-radius: 4px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }

    .form-container button:hover {
      background-color: #1976D2;
    }

    /* üîΩ Responsive */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .sidebar.active {
        display: block !important;
        position: fixed;
        top: 0;
        left: 0;
        background-color: rgba(0, 47, 108, 0.95);
        width: 220px;
        height: 100vh;
        padding-top: 60px;
        z-index: 2000;
      }

      .toggle-btn {
        display: block;
        position: fixed;
        top: 10px;
        left: 10px;
        background-color: #0b3d91;
        color: white;
        border: none;
        padding: 10px 12px;
        font-size: 18px;
        border-radius: 4px;
        z-index: 3000;
      }

      header {
        left: 0;
        width: 100%;
        padding-left: 50px;
        z-index: 1000;
      }

      main {
        margin-left: 0;
        padding-top: 100px;
      }
    }
  </style>
</head>
<body>
    <header>
    <div class="header-left">
      <img src="logo.png" alt="Logo" class="logo-header">
      <h1>Pagos - Ceneco</h1>
    </div>
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </header>
  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');

      document.addEventListener('click', function fueraDeSidebar(e) {
        if (!sidebar.contains(e.target) && !e.target.classList.contains('toggle-btn')) {
          sidebar.classList.remove('active');
          document.removeEventListener('click', fueraDeSidebar);
        }
      });
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }
  </script>
</body

  <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>

  <div class="sidebar" id="sidebar">
    <a href="index.html">üë• Pacientes</a>
    <a href="historia_clinica.html">üìÑ Historia Cl√≠nica</a>
    <a href="pagos.html">üí∞ Pagos</a>
    <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
    <button onclick="logout()">üö™ Cerrar sesi√≥n</button>
  </div>

  <header>
    <div class="header-left">
      <img src="logo.png" alt="Logo" class="logo-header">
      <h1>Gesti√≥n de Pagos - Ceneco</h1>
    </div>
  </header>

  <main>
  <button class="nuevo-btn" onclick="abrirFormularioPago()">+ Registrar Pago</button>

  <div class="form-container" id="formularioPago">
    <h2>Registro de Evaluaciones</h2>
    <form id="pagoForm">
      <label for="paciente">Paciente</label>
      <select id="paciente" required>
        <option value="">Seleccione</option>
      </select>

      <label for="dias">D√≠as evaluados</label>
      <input type="text" id="dias" placeholder="Seleccione d√≠as">

      <label for="obraSocial">Obra Social</label>
      <input type="text" id="obraSocial" readonly>

      <label for="tipoSesion">Tipo de sesi√≥n</label>
      <input type="text" id="tipoSesion">

      <label for="montoSesion">Monto por sesi√≥n</label>
      <input type="text" id="montoSesion">

      <label for="cantidadSesiones">Cantidad de sesiones</label>
      <input type="number" id="cantidadSesiones" min="1" value="1">

      <label for="supervisora">Supervisora</label>
      <input type="text" id="supervisora" readonly>

      <label>Monto total</label>
<div id="montoTotal" class="campo-monto">$0</div>

<label>% Supervisora (20%)</label>
<div id="montoSupervisora" class="campo-monto">$0</div>

<label>% Supervisora 2 (10%)</label>
<div id="montoSupervisora2" class="campo-monto">$0</div>

      <button type="submit">Registrar Pago</button>
      <button type="button" onclick="cerrarFormularioPago()">Cancelar</button>
    </form>
  </div>


    <h2 style="margin-top: 30px;">Pagos Registrados</h2>
    <table id="tablaPagos"></table>

  </main>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/cleave.js@1/dist/cleave.min.js"></script>

<script>
  const token = localStorage.getItem('token');
  const perfil = localStorage.getItem('perfil');

  if (!token || !['admin', 'usuario', 'supervisora'].includes(perfil)) {
    logout();
  }

  const sidebar = document.getElementById('sidebar');
  sidebar.innerHTML = '';

  if (perfil === 'admin' || perfil === 'supervisora') {
  sidebar.innerHTML = `
    <a href="index.html">üë• Pacientes</a>
    <a href="historia_clinica.html">üìÑ Historia Cl√≠nica</a>
    <a href="pagos.html">üí∞ Pagos</a>
    <a href="reportes.html">üìä Reportes</a>
    <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
    <button onclick="logout()">üö™ Cerrar sesi√≥n</button>
  `;
} else if (perfil === 'usuario') {
  sidebar.innerHTML = `
    <a href="historia_clinica.html">üìÑ Historia Cl√≠nica</a>
    <a href="pagos.html">üí∞ Pagos</a>
    <button onclick="logout()">üö™ Cerrar sesi√≥n</button>
  `;
}




  flatpickr("#dias", { mode: "multiple", dateFormat: "Y-m-d" });

  const cleaveMonto = new Cleave('#montoSesion', {
    prefix: '$',
    numeral: true,
    numeralThousandsGroupStyle: 'thousand',
    numeralDecimalMark: ',',
    delimiter: '.'
  });

  document.getElementById('cantidadSesiones').addEventListener('input', calcularMontos);
  document.getElementById('cantidadSesiones').addEventListener('change', calcularMontos);
  document.getElementById('montoSesion').addEventListener('input', calcularMontos);

  async function cargarPacientes() {
    const res = await fetch('/pacientes', { headers: { Authorization: token } });
    const pacientes = await res.json();
    const select = document.getElementById('paciente');
    select.innerHTML = '<option value="">Seleccione</option>';
    pacientes.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.nombre} ${p.apellido} (${p.numero_paciente})`;
      select.appendChild(opt);
    });
  }

  document.getElementById('paciente').addEventListener('change', async (e) => {
    const id = e.target.value;
    if (!id) return;
    const res = await fetch(`/pacientes/${id}`, { headers: { Authorization: token } });
    const p = await res.json();
    document.getElementById('obraSocial').value = p.obra_social || '';
    document.getElementById('tipoSesion').value = p.tipo_sesion || '';
    cleaveMonto.setRawValue(p.monto_sesion || 0);
    setTimeout(() => calcularMontos(), 0);
    document.getElementById('supervisora').value = p.supervisora || '';
  });

  function calcularMontos() {
  console.log("üî• calcularMontos llamado");
  let rawMonto = cleaveMonto.getRawValue();
  rawMonto = rawMonto.replace('$', '').replace(/\./g, '').replace(',', '.').trim();
  const monto = parseFloat(rawMonto) || 0;

  let sesiones = parseInt(document.getElementById('cantidadSesiones').value);
  if (isNaN(sesiones) || sesiones < 1) {
    sesiones = 1;
    document.getElementById('cantidadSesiones').value = 1;
  }

  const total = monto * sesiones;
  const supervisora = total * 0.2;   // 20%
  const supervisora2 = total * 0.1;  // 10%

  document.getElementById('montoTotal').textContent = `$${total.toLocaleString('de-DE')}`;
  document.getElementById('montoSupervisora').textContent = `$${supervisora.toLocaleString('de-DE')}`;
  document.getElementById('montoSupervisora2').textContent = `$${supervisora2.toLocaleString('de-DE')}`;
}



  document.getElementById('pagoForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const pacienteId = document.getElementById('paciente').value;
    const dias = document.getElementById('dias').value;

    let sesiones = parseInt(document.getElementById('cantidadSesiones').value);
    if (isNaN(sesiones) || sesiones < 1) {
      sesiones = 1;
    }

    let rawMonto = document.getElementById('montoSesion').value;
    rawMonto = rawMonto.replace(/\./g, '').replace(',', '.').replace('$', '').trim();
    const monto = parseFloat(rawMonto) || 0;

    const obraSocial = document.getElementById('obraSocial').value;
    const tipoSesion = document.getElementById('tipoSesion').value;

    console.log('‚úÖ Payload antes de enviar', { pacienteId, dias, sesiones, monto });

    const payload = {
      paciente_id: pacienteId,
      dias_evaluados: dias,
      cantidad_sesiones: sesiones,
      monto_sesion: monto,
      obra_social: obraSocial,
      tipo_sesion: tipoSesion
    };

    const res = await fetch('/api/pagos', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': token
      },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert('Pago registrado correctamente');
      document.getElementById('pagoForm').reset();
      cerrarFormularioPago();
      cargarPagos();
    } else {
      alert('Error al registrar el pago');
    }
  });

 
 async function cargarPagos() {
  const res = await fetch('/api/pagos', { headers: { 'Authorization': token } });
  if (!res.ok) return;
  const pagos = await res.json();

  const tabla = document.getElementById('tablaPagos');
tabla.innerHTML = ''; // ‚úÖ borra todo (thead + tbodies)

// ‚úÖ Insertar encabezado de tabla
tabla.innerHTML = `
  <thead>
    <tr>
      <th>ID</th>
      <th>Paciente</th>
      <th>Fecha</th>
      <th>Monto Total</th>
      <th>Monto Supervisora</th>
      <th>Monto Supervisora 2</th>
      <th>D√≠as Evaluados</th>
      <th>Cantidad de sesiones</th>
      <th>Obra Social</th>
      <th>Tipo de sesi√≥n</th>
      <th>Supervisora</th>
      <th>Acciones</th>
    </tr>
  </thead>
`;


  const agrupadoPorPsicopedagoga = {};
  pagos.forEach(p => {
    const key = p.psicopedagoga || 'Sin psicopedagoga';
    if (!agrupadoPorPsicopedagoga[key]) agrupadoPorPsicopedagoga[key] = [];
    agrupadoPorPsicopedagoga[key].push(p);
  });

  Object.keys(agrupadoPorPsicopedagoga).forEach((psico, index) => {
    const tbodyHeader = document.createElement('tbody');
    const trHeader = document.createElement('tr');
    trHeader.style.backgroundColor = '#e0e7ff';
    trHeader.style.cursor = 'pointer';
    trHeader.onclick = () => {
      const rows = document.querySelectorAll(`.grupo-${index}`);
      rows.forEach(row => {
        row.style.display = (row.style.display === 'none' ? 'table-row' : 'none');
      });
    };
    trHeader.innerHTML = `<td colspan="12"><strong>Pagos de ${psico} ‚ñº</strong></td>`;
    tbodyHeader.appendChild(trHeader);
    tabla.appendChild(tbodyHeader);

    const tbodyPagos = document.createElement('tbody');
    agrupadoPorPsicopedagoga[psico].forEach(p => {
      const tr = document.createElement('tr');
      tr.classList.add(`grupo-${index}`);
      tr.style.display = 'none';
      tr.innerHTML = `
  <td>${p.id}</td>
  <td>${p.paciente_nombre || ''}</td>
  <td>${new Date(p.fecha).toLocaleDateString()}</td>
  <td>$${parseFloat(p.monto_total || 0).toFixed(2)}</td>
  <td>$${parseFloat(p.monto_supervisora || 0).toFixed(2)}</td>
  <td>$${parseFloat(p.monto_supervisora2 || 0).toFixed(2)}</td>
  <td>${p.dias_evaluados || ''}</td>
  <td>${p.cantidad_sesiones || ''}</td>
  <td>${p.obra_social || ''}</td>
  <td>${p.tipo_sesion || ''}</td>
  <td>${p.supervisora || ''}</td>
  <td><button onclick="eliminarPago(${p.id})">üóëÔ∏è</button></td>
`;

      tbodyPagos.appendChild(tr);
    });
    tabla.appendChild(tbodyPagos);
  });
}




  function abrirFormularioPago() {
    document.getElementById('formularioPago').style.display = 'block';
  }

  function cerrarFormularioPago() {
    document.getElementById('formularioPago').style.display = 'none';
  }

  function logout() {
    localStorage.clear();
    window.location.href = 'login.html';
  }

  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    sidebar.style.display = sidebar.style.display === 'block' ? 'none' : 'block';
  }

  async function eliminarPago(id) {
    if (confirm("¬øSeguro que quer√©s eliminar este pago?")) {
      const res = await fetch(`/api/pagos/${id}`, {
        method: "DELETE",
        headers: { Authorization: token }
      });
      if (res.ok) {
        cargarPagos();
      } else {
        alert("Error al eliminar pago");
      }
    }
  }

  cargarPacientes();
  cargarPagos();
</script>


</body>
</html>

